(function(e,t){function i(e,i){i=i||{},i.url=i.url||"ws"+window.location.protocol.slice(4)+"//"+window.location.host+"/websocket",this.editor=e;var s=this;this.canopClient=new n.Client({send:function(e){if(s.socket===t||s.socket.readyState!==WebSocket.OPEN)throw new Error("WebSocket is not open for business");s.socket.send(e)}}),this.url=""+i.url,this.socket=null,this.reconnect=i.reconnect===t?!0:!!i.reconnect,this.reconnectionInterval=r,this.socketReceive=this.socketReceive.bind(this),this.editorChange=this.editorChange.bind(this),this.remoteChange=this.remoteChange.bind(this),this.cursorActivity=this.cursorActivity.bind(this),this.signalReceive=this.signalReceive.bind(this),this.canopClient.on("change",this.remoteChange),this.canopClient.on("signal",this.signalReceive),this.clientSelectionWidgets=Object.create(null),this.connect(i)}var n=e.canop,r=256;i.prototype={connect:function(t){var n=this;this.socket=new WebSocket(this.url),this.socket.addEventListener("message",this.socketReceive),this.socket.addEventListener("close",function(e){n.canopClient.emit("unsyncable"),n.reconnect&&(setTimeout(function(){n.connect(t)},n.reconnectionInterval),n.reconnectionInterval<=6e5&&(n.reconnectionInterval*=2))}),this.socket.addEventListener("open",function(){n.reconnectionInterval=r,n.canopClient.emit("syncing")}),t.error&&this.socket.addEventListener("error",t.error),t.open&&this.socket.addEventListener("open",t.open),t.close&&this.socket.addEventListener("close",t.close)},socketReceive:function(t){this.canopClient.receive(""+t.data)},remoteChange:function(t){this.updateEditor(t.changes,t.posChanges)},editorChange:function(t,r,i){var i=i||[],s=r.from,o=r.to,u=r.text.join("\n"),a=r.removed.join("\n"),f=t.indexFromPos(s);a.length>0&&i.push([n.action.stringRemove,[],f,a]),u.length>0&&i.push([n.action.stringAdd,[],f,u]),r.next?this.editorChange(t,r.next,i):this.canopClient.actAtomically(i)},cursorActivity:function(t){var n=this,r=n.editor.listSelections().map(function(e){return[n.editor.indexFromPos(e.head),n.editor.indexFromPos(e.anchor)]});n.canopClient.signal({sel:r})},resetEditor:function(){this.editor.off("change",this.editorChange),this.editor.off("cursorActivity",this.cursorActivity);var t=this.editor.getCursor();this.editor.setValue(""+this.canopClient),this.editor.setCursor(t),this.editor.on("cursorActivity",this.cursorActivity),this.editor.on("change",this.editorChange)},updateEditor:function(t,n){this.editor.off("change",this.editorChange),this.editor.off("cursorActivity",this.cursorActivity);var r=this.editor.indexFromPos(this.editor.getCursor());this.applyDelta(t),this.updateCursor(n,r),this.editor.on("cursorActivity",this.cursorActivity),this.editor.on("change",this.editorChange)},applyDelta:function(t){for(var r=0;r<t.length;r++){var i=t[r];if(i[1]===n.action.set)this.editor.setValue(i[2]);else if(i[1]===n.action.stringAdd)this.editor.replaceRange(i[3],this.editor.posFromIndex(i[2]));else if(i[1]===n.action.stringRemove){var s=this.editor.posFromIndex(i[2]),o=this.editor.posFromIndex(i[2]+i[3].length);this.editor.replaceRange("",s,o)}}},updateCursor:function(t,r){cursor=n.changePosition(r,t,!0),this.editor.setCursor(this.editor.posFromIndex(cursor))},signalReceive:function(n){var r=n.clientId,i=n.data;this.clientSelectionWidgets[r]=this.clientSelectionWidgets[r]||[];var s=this.clientSelectionWidgets[r];for(var o=0;o<s.length;o++){var u=s[o];u.clear()}if(i!==t&&i.sel!==t){var a=i.sel;for(var o=0;o<a.length;o++){var f=a[o],s=this.addSelection(f,r);this.clientSelectionWidgets[r]=this.clientSelectionWidgets[r].concat(s)}}},addSelection:function(t,n){var r=[this.addUiCursor(t[0],n)];return t[0]!==t[1]&&r.push(this.addUiSelection(t,n)),r},addUiCursor:function(t,n){var r=this.editor.posFromIndex(t),i=this.editor.cursorCoords(r),s=document.createElement("span"),o=this.colorFromName(n.toString());s.style.backgroundColor=o,s.style.width="2px",s.style.marginLeft="-1px",s.style.position="absolute",s.style.height=i.bottom-i.top+"px";var u=document.createElement("span");return u.style.display="none",u.style.padding="0 0.7em",u.style.borderRadius="3px",u.style.backgroundColor=o,u.textContent=n,s.appendChild(u),s.addEventListener("mouseenter",function(){u.style.display="inline"}),s.addEventListener("mouseleave",function(){u.style.display="none"}),this.editor.setBookmark(r,{widget:s,insertLeft:!0})},addUiSelection:function(t,n){var r=this.colorFromName(n.toString(),.9);if(t[0]<t[1])var i=t[0],s=t[1];else var i=t[1],s=t[0];var o=this.editor.posFromIndex(i),u=this.editor.posFromIndex(s);return this.editor.markText(o,u,{css:"background-color:"+r})},rgbFromLch:function(t,n,r){var i=r/60,s=n*(1-Math.abs(i%2-1)),o=0,u=0,a=0;i>=5?(o=n,u=0,a=s):i>=4?(o=s,u=0,a=n):i>=3?(o=0,u=s,a=n):i>=2?(o=0,u=n,a=s):i>=1?(o=s,u=n,a=0):i>=0&&(o=n,u=s,a=0);var f=t-(.3*o+.59*u+.11*a);return o=(o+f)*256|0,u=(u+f)*256|0,a=(a+f)*256|0,"rgb("+o+","+u+","+a+")"},hueFromName:function(t){var n=0;for(var r=0;r<t.length;r++)n=(n+t.charCodeAt(r))%360;return n*93%360},colorFromName:function(n,r){return r===t&&(r=.7),this.rgbFromLch(r,.6,this.hueFromName(n))}},e.CanopCodemirrorHook=i})(this);